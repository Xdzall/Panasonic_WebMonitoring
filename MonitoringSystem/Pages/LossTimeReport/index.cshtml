@page
@model MonitoringSystem.Pages.LossTimeReport.indexModel
@{
    ViewData["Title"] = "Loss Time Report";
    string[] months = { "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar" };
}

<div class="container-fluid mt-3">
    <div class="row g-3 align-items-center justify-content-between flex-wrap mb-4">
        <div class="col-auto">
            <form method="get" id="filterForm" class="row g-3 align-items-end">
                <div class="col-auto">
                    @* <label class="form-label fw-bold text-muted">Selected Year</label> *@
                    <select class="form-select form-select-sm" id="SelectedYear" name="SelectedYear" asp-for="SelectedYear">
                        @for (int i = DateTime.Now.Year; i >= 2020; i--)
                        {
                            <option value="@i">@i</option>
                        }
                    </select>
                </div>
                <div class="col-auto">
                    @* <label class="form-label fw-bold small text-muted">Machine Line</label> *@
                    <select name="MachineLine" class="form-select form-select-sm" asp-for="MachineLine">
                        <option value="All">All Lines</option>
                        <option value="MCH1-01">(CU)</option>
                        <option value="MCH1-02">(CS)</option>
                    </select>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-sm text-white" style="background-color: rgb(61, 121, 176);">
                        <i class="fas fa-filter"></i> Apply Filter
                    </button>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-sm text-white" style="background-color: rgb(25, 135, 84);" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-file-excel me-2"></i> Manage BP
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
        @if (TempData["Error"] != null)
        {
            <div id="errorToast" class="toast align-items-center text-bg-danger border-0 shadow" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        @TempData["Error"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        }
        @if (TempData["Success"] != null)
        {
            <div id="successToast" class="toast align-items-center text-bg-success border-0 shadow" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        @TempData["Success"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        }
    </div>

    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 fw-bold">
                Actual vs BP : @(Model.MachineLine == "All" ? "All Lines Combined" : Model.MachineLine)
                (Apr @Model.SelectedYear - Mar @(Model.SelectedYear + 1))
            </h5>
        </div>
        <div class="card-body">
            @if (Model.ChartDataJson == "{}" || !Model.Categories.Any())
            {
                <div class="alert alert-warning text-center">
                    No data found for Fiscal Year @Model.SelectedYear. Please check if data exists in database.
                </div>
            }
            <div style="height: 420px; width: 100%;">
                <canvas id="monthlyLossChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-dark text-white py-2">
            <h6 class="mb-0">Detailed Loss Report</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-striped text-center align-middle w-100 mb-0" id="lossTimeTable">
                    <thead class="bg-light sticky-top">
                        <tr>
                            <th rowspan="2" class="align-middle" style="min-width: 150px;">Loss Category</th>
                            @foreach (var m in months)
                            {
                                <th colspan="2">@m</th>
                            }
                        </tr>
                        <tr>
                            @for (int i = 0; i < 12; i++)
                            {
                                <th class="fw-bold small">BP</th>
                                <th class="fw-bold small">Act</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Categories.Any())
                        {
                            string currentGroup = "";

                            foreach (var cat in Model.Categories)
                            {
                                string groupName = Model.GetCategoryGroup(cat);

                                if (groupName != currentGroup)
                                {
                                    <tr class="table-secondary">
                                        <td colspan="25" class="text-center fw-bold text-uppercase py-1" style="letter-spacing: 1px;">
                                            @groupName
                                        </td>
                                    </tr>
                                    currentGroup = groupName;
                                }

                                <tr>
                                    <td class="text-start fw-bold">@cat</td>
                                    @for (int i = 0; i < 12; i++)
                                    {
                                        var planVal = Model.DetailPlans.ContainsKey(cat) ? Model.DetailPlans[cat][i] : 0;
                                        var actVal = Model.DetailActuals.ContainsKey(cat) ? Model.DetailActuals[cat][i] : 0;

                                        <td class="text-center fw-bold">@planVal</td>
                                        <td class="text-center fw-bold">@actVal</td>

                                        @* <td class="@(actVal > planVal ? "text-danger fw-bold" : "text-dark")">
                                             @actVal
                                        </td> *@
                                    }
                                </tr>
                            }
                            <tr class="table-dark fw-bold">
                                <td class="text-start">TOTAL LOSS</td>
                                @for (int i = 0; i < 12; i++)
                                {
                                    <td>@Model.TotalPlanPerMonth[i].ToString("N1")</td>
                                    <td>@Model.TotalActualPerMonth[i].ToString("N1")</td>
                                }
                            </tr>
                        }
                        else
                        {
                            <tr><td colspan="25">No Data Available</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="uploadModalLabel"><i class="fas fa-file-upload"></i> Upload BP Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" enctype="multipart/form-data" asp-page-handler="ImportExcel">
                <div class="modal-body">
                    <input type="hidden" name="SelectedYear" value="@Model.SelectedYear" />
                    <input type="hidden" name="MachineLine" value="@Model.MachineLine" />
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. Select Target Machine for Plan</label>
                        <select name="UploadMachineLine" class="form-select" required>
                            <option value="MCH1-01">MCH1-01 (CU)</option>
                            <option value="MCH1-02">MCH1-02 (CS)</option>
                        </select>
                        <div class="form-text text-muted">You must specify which machine this file belongs to.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">2. Choose Excel File</label>
                        <input type="file" name="UploadedExcel" class="form-control" accept=".xlsx" required />
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">Need the format?</span>
                        <a asp-page-handler="DownloadTemplate" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download"></i> Download Template
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-small text-white" style="background-color: rgb(25, 135, 84);">Import BP</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="~/js/chart.umd.min.js"></script>
<script>
        document.addEventListener("DOMContentLoaded", function() {
        var chartData = @Html.Raw(Model.ChartDataJson);
        var ctx = document.getElementById('monthlyLossChart').getContext('2d');

        // Warna untuk stack bar (Loss Categories)
        const barColors = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
            '#858796', '#5a5c69', '#fd7e14', '#20c997', '#6f42c1'
        ];

        let datasets = [];
        let colorIdx = 0;

        // 1. Loop Categories untuk membuat Stacked Bar
        if(chartData.Categories){
            chartData.Categories.forEach((cat) => {
                let color = barColors[colorIdx % barColors.length];

                // Dataset Actual Bar
                datasets.push({
                    label: cat + ' (Act)',
                    data: chartData.Actuals[cat],
                    backgroundColor: color,
                    stack: 'Actual',
                    order: 2 // Layer di belakang garis
                });

                // Dataset Plan Bar
                datasets.push({
                    label: cat + ' (Plan)',
                    data: chartData.Plans[cat],
                    backgroundColor: color,
                    stack: 'Plan',
                    opacity: 0.6, // Agak transparan untuk membedakan
                    order: 2
                });
                colorIdx++;
            });
        }

        // 2. TAMBAHKAN LINE CHART: ACTUAL RATIO
        datasets.push({
            label: 'Actual Ratio (%)',
            data: chartData.RatioActual, // Data dari C#
            type: 'line',
            borderColor: '#e74a3b', // Merah
            backgroundColor: '#e74a3b',
            borderWidth: 3,
            pointRadius: 4,
            yAxisID: 'y_ratio', // Menggunakan sumbu kanan
            tension: 0.1,
            order: 0 // Layer paling depan
        });

        // 3. TAMBAHKAN LINE CHART: PLAN RATIO
        datasets.push({
            label: 'Plan Ratio (%)',
            data: chartData.RatioPlan, // Data dari C#
            type: 'line',
            borderColor: '#4e73df', // Biru
            backgroundColor: '#4e73df',
            borderWidth: 2,
            borderDash: [5, 5], // Garis putus-putus
            pointRadius: 3,
            yAxisID: 'y_ratio', // Menggunakan sumbu kanan
            tension: 0.1,
            order: 0
        });

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.Labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y;
                                    // Tambah tanda % jika dataset menggunakan sumbu kanan
                                    if (context.dataset.yAxisID === 'y_ratio') label += '%';
                                }
                                return label;
                            }
                        }
                    },
                    legend: { display: false } // Hide legend jika terlalu ramai
                },
                scales: {
                    x: {
                        stacked: true,
                        title: { display: true, text: 'Fiscal Month' }
                    },
                    y: { // Sumbu Kiri (Menit Loss)
                        type: 'linear',
                        display: true,
                        position: 'left',
                        stacked: true,
                        title: { display: true, text: 'Loss Time (Minutes)' }
                    },
                    y_ratio: { // Sumbu Kanan (Persentase)
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false // Hilangkan grid agar tidak tumpang tindih
                        },
                        title: { display: true, text: 'Ratio (%)', color: '#333' },
                        ticks: {
                            callback: function(value) { return value + "%" }
                        },
                        suggestedMax: 5 // Opsional: set max default agar garis tidak terlalu mepet atas
                    }
                }
            }
        });
    });
</script>

<style>
    .table th, .table td {
        white-space: nowrap;
        font-size: 0.7rem;
    }

        .table th:first-child, .table td:first-child {
            white-space: normal;
            position: sticky;
            left: 0;
            background-color: #fff;
            z-index: 2;
        }

    .table-dark td:first-child {
        background-color: #212529;
        color: white;
    }
</style>