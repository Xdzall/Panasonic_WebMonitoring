@page
@model MonitoringSystem.Pages.LossTimeReport.indexModel
@{
    ViewData["Title"] = "Loss Time Report";
}

<div class="container-fluid mt-3">
    <div class="row g-3 align-items-center justify-content-between flex-wrap mb-4">
        <div class="col-auto">
            <form method="get" id="filterForm" class="row g-3 align-items-end">
                <div class="col-auto">
                    <label class="form-label fw-bold small text-muted">Selected Year</label>
                    <select class="form-select" id="SelectedYear" name="SelectedYear" asp-for="SelectedYear">
                        @for (int i = DateTime.Now.Year; i >= 2000; i--)
                        {
                            <option value="@i">@i</option>
                        }
                    </select>
                </div>
                <div class="col-auto">
                    <label class="form-label fw-bold small text-muted">Machine Line</label>
                    <select name="MachineLine" class="form-select" asp-for="MachineLine">
                        <option value="All">All Lines</option>
                        <option value="MCH1-01">(CU)</option>
                        <option value="MCH1-02">(CS)</option>
                    </select>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter"></i> Apply Filter
                    </button>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-success shadow-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-file-excel me-2"></i> Manage Plan
                    </button>
                </div>

                @*@if (TempData["Error"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i> @TempData["Error"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }
                @if (TempData["Success"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i> @TempData["Success"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }*@
            </form>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
        @if (TempData["Error"] != null)
        {
            <div id="errorToast" class="toast align-items-center text-bg-danger border-0 shadow" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        @TempData["Error"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                            data-bs-dismiss="toast"></button>
                </div>
            </div>
        }

        @if (TempData["Success"] != null)
        {
            <div id="successToast" class="toast align-items-center text-bg-success border-0 shadow" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        @TempData["Success"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                            data-bs-dismiss="toast"></button>
                </div>
            </div>
        }
    </div>

    <div class="card shadow border-0">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 fw-bold">
                Actual vs Plan: @(Model.MachineLine == "All" ? "All Lines Combined" : Model.MachineLine)
                (Apr @Model.SelectedYear - Mar @(Model.SelectedYear + 1))
            </h5>
        </div>
        <div class="card-body">
            @if (Model.ChartDataJson == "{}" || Model.ChartDataJson.Contains("\"ActualData\":[0,0,0,0,0,0,0,0,0,0,0,0]"))
            {
                <div class="alert alert-warning text-center">
                    No data found for Fiscal Year @Model.SelectedYear. Please check if data exists in database.
                </div>
            }
            <div style="height: 450px; width: 100%;">
                <canvas id="monthlyLossChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="uploadModalLabel"><i class="fas fa-file-upload"></i> Upload Plan Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form method="post" enctype="multipart/form-data" asp-page-handler="ImportExcel">
                <div class="modal-body">
                    <input type="hidden" name="SelectedYear" value="@Model.SelectedYear" />
                    <input type="hidden" name="MachineLine" value="@Model.MachineLine" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">1. Select Target Machine for Plan</label>
                        <select name="UploadMachineLine" class="form-select" required>
                            <option value="MCH1-01">MCH1-01 (CU)</option>
                            <option value="MCH1-02">MCH1-02 (CS)</option>
                        </select>
                        <div class="form-text text-muted">You must specify which machine this file belongs to.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">2. Choose Excel File</label>
                        <input type="file" name="UploadedExcel" class="form-control" accept=".xlsx" required />
                    </div>

                    <hr />
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">Need the format?</span>
                        <a asp-page-handler="DownloadTemplate" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download"></i> Download Template
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-success">Import Plan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="~/js/chart.umd.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var chartData = @Html.Raw(Model.ChartDataJson);

        var ctx = document.getElementById('monthlyLossChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.Labels,
                datasets: [
                    {
                        label: 'Total Actual Loss (Min)',
                        data: chartData.ActualData,
                        backgroundColor: 'rgba(220, 53, 69, 0.8)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Total Plan (Min)',
                        data: chartData.PlanData,
                        backgroundColor: 'rgba(13, 110, 253, 0.8)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Duration (Minutes)' }
                    }
                }
            }
        });

        const errorToast = document.getElementById("errorToast");
        const successToast = document.getElementById("successToast");

        if (errorToast) {
            new bootstrap.Toast(errorToast, { delay: 5000 }).show();
        }

        if (successToast) {
            new bootstrap.Toast(successToast, { delay: 3500 }).show();
        }
    });
</script>


@*
<div class="table-responsive">
    <table class="table table-bordered text-center align-middle w-100" id="lossTimeTable">
        <thead class="table-dark">
            <tr>
                <th id="toggleExtraRows" style="min-width: 150px; cursor: pointer; user-select: none;">
                    <div class="d-flex align-items-center">
                        <i id="toggleIcon" class="bi bi-chevron-down me-2"></i>
                        <span>Loss Category</span>
                    </div>
                </th>
                @foreach (var monthLabel in Model.MonthLabels)
                {
                        <th>@monthLabel</th>
                }
            </tr>
        </thead>
        <tbody>
            <tr class="table-secondary extra-row">
                <td colspan="13" class="text-center">Fixed Loss</td>
            </tr>
            <tr class="extra-row">
                <td>Morning Assembly</td>
                @for (int i = 0; i < 12; i++)
                {
                        <td>
                        @{
                            var minutes = Model.ReportData.MonthlyLosses.ContainsKey("Loss Awal Hari") ? Model.SecondsToMinutes(Model.ReportData.MonthlyLosses["Loss Awal Hari"][i]) : 0;
                            @(minutes > 0 ? minutes.ToString("F1") : "0")
                        }
                        </td>
                }
            </tr>
            <tr class="extra-row">
                <td>Break Time (AM/PM)</td>
                @for (int i = 0; i < 12; i++)
                {
                    <td>0</td>
                }
            </tr>
            <tr class="extra-row">
                <td>Cleaning</td>
                @for (int i = 0; i < 12; i++)
                {
                    <td>0</td>
                }
            </tr>
             <tr class="extra-row">
                <td>General Assembly</td>
                @for (int i = 0; i < 12; i++)
                {
                    <td>0</td>
                }
            </tr>

            <tr class="table-secondary extra-row">
                <td colspan="13" class="text-center">Control Loss</td>
            </tr>
             <tr class="extra-row">
                <td>Material Shortage External</td>
                @for (int i = 0; i < 12; i++)
                {
                        <td>
                        @{
                            var minutes = Model.ReportData.MonthlyLosses.ContainsKey("Material Shortage External") ? Model.SecondsToMinutes(Model.ReportData.MonthlyLosses["Material Shortage External"][i]) : 0;
                            @(minutes > 0 ? minutes.ToString("F1") : "0")
                        }
                        </td>
                }
            </tr>

            <tr class="table-secondary extra-row">
                <td colspan="13" class="text-center">Operation Loss</td>
            </tr>
             <tr class="extra-row">
                <td>Model Change</td>
                @for (int i = 0; i < 12; i++)
                {
                        <td>
                        @{
                            var minutes = Model.ReportData.MonthlyLosses.ContainsKey("Change Model") ? Model.SecondsToMinutes(Model.ReportData.MonthlyLosses["Change Model"][i]) : 0;
                            @(minutes > 0 ? minutes.ToString("F1") : "0")
                        }
                        </td>
                }
            </tr>
            <tr class="extra-row">
                <td>Man Power Adjustment</td>
                @for (int i = 0; i < 12; i++)
                {
                        <td>
                        @{
                            var minutes = Model.ReportData.MonthlyLosses.ContainsKey("MP Adjustment") ? Model.SecondsToMinutes(Model.ReportData.MonthlyLosses["MP Adjustment"][i]) : 0;
                            @(minutes > 0 ? minutes.ToString("F1") : "0")
                        }
                        </td>
                }
            </tr>

            <tr class="table-secondary extra-row">
                <td colspan="13" class="text-center">Balance Loss</td>
            </tr>
             <tr class="extra-row">
                <td>Material Shortage Internal</td>
                @for (int i = 0; i < 12; i++)
                {
                        <td>
                        @{
                            var minutes = Model.ReportData.MonthlyLosses.ContainsKey("Material Shortage Internal") ? Model.SecondsToMinutes(Model.ReportData.MonthlyLosses["Material Shortage Internal"][i]) : 0;
                            @(minutes > 0 ? minutes.ToString("F1") : "0")
                        }
                        </td>
                }
            </tr>

            <tr class="table-secondary extra-row">
                <td colspan="13" class="text-center">Delivery Loss</td>
            </tr>
             <tr class="extra-row">
                <td>Material Shortage Inhouse</td>
                @for (int i = 0; i < 12; i++)
                {
                        <td>
                        @{
                            var minutes = Model.ReportData.MonthlyLosses.ContainsKey("Material Shortage Inhouse") ? Model.SecondsToMinutes(Model.ReportData.MonthlyLosses["Material Shortage Inhouse"][i]) : 0;
                            @(minutes > 0 ? minutes.ToString("F1") : "0")
                        }
                        </td>
                }
            </tr>

            <tr class="table-secondary extra-row">
                <td colspan="13" class="text-center">Loss Adjustment</td>
            </tr>
            <tr class="extra-row">
                <td>Quality Trouble</td>
                @for (int i = 0; i < 12; i++)
                {
                        <td>
                        @{
                            var minutes = Model.ReportData.MonthlyLosses.ContainsKey("Quality Trouble") ? Model.SecondsToMinutes(Model.ReportData.MonthlyLosses["Quality Trouble"][i]) : 0;
                            @(minutes > 0 ? minutes.ToString("F1") : "0")
                        }
                        </td>
                }
            </tr>
            <tr class="extra-row">
                <td>Rework</td>
                @for (int i = 0; i < 12; i++)
                {
                        <td>
                        @{
                            var minutes = Model.ReportData.MonthlyLosses.ContainsKey("Rework") ? Model.SecondsToMinutes(Model.ReportData.MonthlyLosses["Rework"][i]) : 0;
                            @(minutes > 0 ? minutes.ToString("F1") : "0")
                        }
                        </td>
                }
            </tr>
            <tr class="extra-row">
                <td>Machine & Tools Trouble</td>
                @for (int i = 0; i < 12; i++)
                {
                        <td>
                        @{
                            var minutes = Model.ReportData.MonthlyLosses.ContainsKey("Machine Trouble") ? Model.SecondsToMinutes(Model.ReportData.MonthlyLosses["Machine Trouble"][i]) : 0;
                            @(minutes > 0 ? minutes.ToString("F1") : "0")
                        }
                        </td>
                }
            </tr>

            <tr class="table-secondary extra-row">
                <td colspan="13" class="text-center">Total Loss & Actual</td>
            </tr>
            <tr class="table-group-divider">
                <td class="fw-bold">Total Working Time</td>
                @foreach (var workingTime in Model.TotalWorkingTimeByMonth)
                {
                    <td>@workingTime.ToString("N0")</td>
                }
            </tr>
            <tr>
                <td class="fw-bold">Total Loss</td>
                @for (int i = 0; i < 12; i++)
                {
                        <td>@Model.SecondsToMinutes(Model.ReportData.TotalLossByMonth[i]).ToString("F1")</td>
                }
            </tr>
             <tr>
                <td class="fw-bold">Actual Loss = Total Loss - Fixed Loss</td>
                @foreach (var actualLoss in Model.ActualLossByMonth)
                {
                    <td>@actualLoss.ToString("F1")</td>
                }
            </tr>
            <tr>
                <td class="fw-bold">Actual WT = Total WT - Fixed Loss</td>
                @foreach (var actualWt in Model.ActualWtByMonth)
                {
                    <td>@actualWt.ToString("F1")</td>
                }
            </tr>
            <tr>
                <td class="fw-bold">Actual Loss vs Actual Working Time (%)</td>
                @foreach (var presentage in Model.ActualLossVsActualWtPresentage)
                {
                    <td>@presentage</td>
                }
            </tr>
            <tr>
                <td class="fw-bold">Total Loss vs Total Working Time (%)</td>
                @foreach (var presentage in Model.TotalLossVsTotalWtPresentage)
                {
                    <td>@presentage</td>
                }
            </tr>
            <tr>
                <td class="fw-bold">BP Total Loss vs Total Working Time (%)</td>
                @for (int i = 0; i < 12; i++)
                {
                    <td>0%</td>
                }
            </tr>
        </tbody>
    </table>
</div>

<style>
    .table th,
    .table td {
        font-size: 10px;
        padding: 0.3rem;
        white-space: nowrap;
        word-wrap: break-word;
        vertical-align: middle;
    }

    .table th:first-child,
    .table td:first-child {
        min-width: 100px;
        white-space: normal;
        text-align: left;
        padding-left: .5rem;
    }
    .extra-row {
        display: none;
    }
</style>
*@
@* <script src="~/js/chart.umd.min.js"></script> *@
@* <script> *@
@*     document.addEventListener("DOMContentLoaded", function() { *@
@*         // Data dari backend *@
@*         var chartData = @Html.Raw(Model.ChartDataJson); *@

@*         var ctx = document.getElementById('lossTimeChart').getContext('2d'); *@
@*         new Chart(ctx, { *@
@*             type: 'bar', *@
@*             data: { *@
@*                 labels: chartData.Labels, *@
@*                 datasets: [ *@
@*                     { *@
@*                         label: 'Actual Loss (Min)', *@
@*                         data: chartData.ActualData, *@
@*                         backgroundColor: 'rgba(220, 53, 69, 0.7)', // Merah *@
@*                         borderColor: 'rgba(220, 53, 69, 1)', *@
@*                         borderWidth: 1 *@
@*                     }, *@
@*                     { *@
@*                         label: 'Plan Limit (Min)', *@
@*                         data: chartData.PlanData, *@
@*                         backgroundColor: 'rgba(13, 110, 253, 0.7)', // Biru *@
@*                         borderColor: 'rgba(13, 110, 253, 1)', *@
@*                         borderWidth: 1 *@
@*                     } *@
@*                 ] *@
@*             }, *@
@*             options: { *@
@*                 responsive: true, *@
@*                 maintainAspectRatio: false, *@
@*                 scales: { *@
@*                     y: { *@
@*                         beginAtZero: true, *@
@*                         title: { display: true, text: 'Duration (Minutes)' } *@
@*                     }, *@
@*                     x: { *@
@*                         ticks: { autoSkip: false, maxRotation: 90, minRotation: 45 } *@
@*                     } *@
@*                 }, *@
@*                 plugins: { *@
@*                     tooltip: { *@
@*                         mode: 'index', *@
@*                         intersect: false *@
@*                     } *@
@*                 } *@
@*             } *@
@*         }); *@
@*     }); *@
@* </script> *@