@page
@model MonitoringSystem.Pages.Shared.ProductionPlanModel
@{
    ViewData["Title"] = "Production Plan";
    string formattedDate = DateTime.Now.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("en-US"));
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="~/css/Sidebar.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    @* SweetAlert2 *@
    <link rel="stylesheet" href="~/css/sweetalert2.css" />

    <style>
        .dropdown {
            border: 1px solid #ccc;
            position: absolute;
            z-index: 1000;
            display: none;
            background-color: white;
            max-height: 150px;
            overflow-y: auto;
            width: 200px;
        }

            .dropdown div {
                padding: 10px;
                cursor: pointer;
            }

                .dropdown div:hover {
                    background-color: #f0f0f0;
                }
    </style>
</head>
<body>
    <div class="row g-3 align-items-center justify-content-between flex-wrap">
        <div class="col-auto">
            <form method="get" class="row g-3 align-items-center">
                <div class="col-auto d-flex gap-2 align-items-center">
                    <label class="fs-10 fw-bold">Date:</label>
                    <input type="date" class="form-control form-control-sm border-dark"
                           name="FilterDate"
                           value="@Model.CurrentDate.ToString("yyyy-MM-dd")" />
                </div>

                <div class="col-auto d-flex gap-2 align-items-center">
                    <label class="fs-10 fw-bold">Machine:</label>
                    <select class="form-select form-select-sm border-dark filter-control" name="FilterMachineCode" asp-for="FilterMachineCode">
                        <option value="MCH1-01">CU</option>
                        <option value="MCH1-02">CS</option>
                    </select>
                </div>

                <div class="col-auto d-flex gap-2">
                    <button type="submit" class="btn btn-sm fw-bold fs-6 text-white" style="background-color: rgb(61, 121, 176);">Search</button>
                    <a href="/Summary/ProductionPlan" class="btn btn-sm fw-bold fs-6 text-white" style="background-color: rgb(176, 61, 61);">Reset</a>
                </div>
            </form>
        </div>
        <div class="col-auto ms-auto">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    Upload
                </button>
            </div>
        </div>
        <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header d-flex justify-content-between align-items-center">
                        <h5 class="modal-title" id="uploadModalLabel">Upload Monthly Plan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        @* Bagian Download Template *@
                        <div class="mb-3 text-center">
                            <div class="d-flex justify-content-center gap-2">
                                @* Pastikan backend OnGetDownloadTemplate sudah mendukung format baru *@
                                <a asp-page-handler="DownloadTemplate" asp-route-type="cu" class="btn btn-sm btn-outline-success d-flex align-items-center gap-1">
                                    <i class="bi bi-file-earmark-excel-fill"></i>
                                    Template
                                </a>
                            </div>
                        </div>
                        <hr />

                        @* Form Upload *@
                        <form method="post" enctype="multipart/form-data" asp-page-handler="Upload">
                            @* 1. File Input (Sesuai dengan IFormFile UploadedFile di Backend) *@
                            <div class="form-group mb-3">
                                <label for="UploadedFile" class="form-label fw-bold">Pilih File Excel:</label>
                                <input type="file" id="UploadedFile" name="UploadedFile" class="form-control" accept=".xlsx, .xls" required>
                            </div>

                            @* 2. Target Machine (Sesuai dengan string TargetMachine di Backend) *@
                            <div class="form-group mb-3">
                                <label for="TargetMachine" class="form-label fw-bold">Untuk Mesin:</label>
                                <select id="TargetMachine" name="TargetMachine" class="form-select" required>
                                    <option value="MCH1-01">CU</option>
                                    <option value="MCH1-02">CS</option>
                                </select>
                            </div>

                            <div class="row">
                                @* 3. Target Month (Sesuai dengan int TargetMonth di Backend) *@
                                <div class="col-md-6 form-group mb-3">
                                    <label for="TargetMonth" class="form-label fw-bold">Bulan:</label>
                                    <select id="TargetMonth" name="TargetMonth" class="form-select" required>
                                        @for (int i = 1; i <= 12; i++)
                                        {
                                            // Menampilkan Nama Bulan (Januari, Februari...) tapi mengirim Value Angka (1, 2...)
                                            <option value="@i" selected="@(i == DateTime.Now.Month ? "selected" : null)">
                                                @System.Globalization.CultureInfo.GetCultureInfo("en-US").DateTimeFormat.GetMonthName(i)
                                            </option>
                                        }
                                    </select>
                                </div>

                                @* 4. Target Year (Sesuai dengan int TargetYear di Backend) *@
                                <div class="col-md-6 form-group mb-3">
                                    <label for="TargetYear" class="form-label fw-bold">Tahun:</label>
                                    <select id="TargetYear" name="TargetYear" class="form-select" required>
                                        @for (int i = DateTime.Now.Year - 3; i <= DateTime.Now.Year + 1; i++)
                                        {
                                            <option value="@i" selected="@(i == DateTime.Now.Year ? "selected" : null)">@i</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-3">
                                <button type="submit" class="btn btn-success fw-bold">
                                    <i class="bi bi-upload"></i> Upload
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <form id="form-production-plan" method="post" asp-page-handler="InsertProductionRecord">
            <input type="hidden" name="FilterMachineCode" value="@Model.FilterMachineCode" />
            <input type="hidden" name="TargetDate" value="@Model.CurrentDate.ToString("yyyy-MM-dd")" />
            <div class="card-header">
                <div class="row">
                    <div class="col-6">
                        <div class="card text-center" style="background-color:#87bbfa">
                            <p class="pt-2 fs-7">Date :</p>
                            <p class="fs-4 fw-bold">
                                @Model.CurrentDate.ToString("dd MMM yyyy", new System.Globalization.CultureInfo("en-US"))
                            </p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card text-center" style="background-color:#87bbfa">
                            <p class="pt-2 fs-7">Total Quantity :</p>
                            <p class="fs-4 fw-bold">@(Model.GrandTotal != null ? Model.GrandTotal : "0")</p>
                        </div>
                    </div>
                </div>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr class="text-center">
                        <th colspan="3">Original</th>
                        <th colspan="8">Current</th>
                    </tr>

                    <tr class="text-center">
                        <th rowspan="2">No</th>
                        <th rowspan="2">Model Name</th>
                        <th rowspan="2">Quantity</th>
                        <th rowspan="2">Model Name</th>

                        <th colspan="2">Plan</th>

                        <th colspan="2">No Of Direct Worker</th>

                        <th rowspan="2">Shift</th>
                        <th rowspan="2">Qty/Hour</th>
                        <th rowspan="2">Hour</th>
                        <th rowspan="2">Action</th>
                    </tr>

                    <tr class="text-center">
                        <th>Quantity</th>
                        <th>Overtime</th>
                        <th>Normal</th>
                        <th>Overtime</th>
                    </tr>
                </thead>

                <tbody id="production-table-body">
                    @{
                        // LOGIC: Default 5 baris, atau mengikuti jumlah data jika lebih dari 5
                        int minRows = 5;
                        int dataCount = Model.listRecords.Count;
                        int totalRows = dataCount > minRows ? dataCount : minRows;
                    }

                    @for (int i = 0; i < totalRows; i++)
                    {
                        var record = dataCount > i ? Model.listRecords[i] : null;
                        <tr>
                            <th scope="row" class="text-center align-middle row-number">@(i + 1)</th>
                            @* Kolom Original (Read Only / Disabled) *@
                            <td>
                                <div class="input-group m-1">
                                    <input disabled type="hidden" name="IdModel[@i]" value="@(record?.Id)" />
                                    <input disabled type="text" class="form-control" name="OriginalModelName[@i]" value="@(record?.ModelName)" placeholder="-" />
                                </div>
                            </td>
                            <td>
                                <div class="m-1">
                                    <input disabled type="text" class="form-control" name="OriginalQuantity[@i]" value="@(record?.Quantity.ToString())" placeholder="-" />
                                </div>
                            </td>

                            @* Kolom Current (Input User) *@
                            <td>
                                <div class="input-group m-1 position-relative">
                                    <input type="hidden" name="IdModel[@i]" value="@(record?.Id)" />
                                    @* Tambahkan class 'productInput' agar terdeteksi JS *@
                                    <input type="text" class="form-control productInput" name="ModelName[@i]" value="@(record?.ModelName)" placeholder="Pilih Model" autocomplete="off" />
                                    <a class="btn btn-primary input-group-text" data-bs-toggle="modal" data-bs-target="#new-model-modal">Opsi</a>
                                    @* Dropdown Container *@
                                    <div class="dropdown custom-dropdown" style="top: 100%; left: 0; width: 100%;"></div>
                                </div>
                            </td>
                            <td>
                                <div class="m-1">
                                    <input type="text" class="form-control" name="Quantity[@i]" value="@(record?.Quantity.ToString())" placeholder="Qty" autocomplete="off" />
                                </div>
                            </td>
                            <td>
                                <div class="m-1">
                                    <input type="text" class="form-control" name="Overtime[@i]" value="@(record?.Overtime.ToString())" placeholder="Ovt" autocomplete="off" />
                                </div>
                            </td>
                            <td>
                                <div class="m-1">
                                    <input type="number" class="form-control" name="NoOfDirectWorker[@i]" value="@(record?.NoDirectOfWorker.ToString())" placeholder="Worker" autocomplete="off" />
                                </div>
                            </td>
                            <td>
                                <div class="m-1">
                                    <input type="number" class="form-control" name="NoOfDirectWorkerOvertime[@i]" value="@(record?.NoDirectOfWorkerOvertime.ToString())" placeholder="Ovt" autocomplete="off" />
                                </div>
                            </td>
                            <td class="align-middle">
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="Shift[@i]"
                                               value="1"
                                        @(record?.Shift?.Contains("1") == true ? "checked" : "")>
                                        <label class="form-check-label">S1</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="Shift[@i]"
                                               value="2"
                                        @(record?.Shift?.Contains("2") == true ? "checked" : "")>
                                        <label class="form-check-label">S2</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="Shift[@i]"
                                               value="3"
                                        @(record?.Shift?.Contains("3") == true ? "checked" : "")>
                                        <label class="form-check-label">S3</label>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="Shift[@i]"
                                               value="NS"
                                        @(record?.Shift?.Contains("NS") == true ? "checked" : "")>
                                        <label class="form-check-label">NS</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="m-1">
                                    <input type="text" class="form-control" name="QtyHour[@i]" value="@(record?.QtyHour.ToString())" placeholder="Qty/Hr" autocomplete="off" />
                                </div>
                            </td>
                            <td>
                                <div class="m-1">
                                    <input type="text" class="form-control" name="Hour[@i]" value="@(record?.Hour ?? 0)" readonly />
                                </div>
                            </td>
                            <td>
                                <div class="d-flex justify-content-center">
                                    @if (record != null)
                                    {
                                        <a class="btn btn-warning btn-sm mt-1 me-1" data-bs-toggle="modal" data-bs-target="#edit-model" onclick="setModalData(this)">Edit</a>
                                        <a class="btn btn-danger btn-sm mt-1" data-bs-toggle="modal" data-bs-target="#delete-model" onclick="setDeleteRecordId(@(record?.Id))">Del</a>
                                    }
                                    else
                                    {
                                        // Tombol Hapus Baris (Client Side)
                                        <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeRow(this)">Del</button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            @* Tombol Tambah Baris & Kolom Komentar *@
            <div class="row">
                <div class="col-12 mb-3">
                    <button type="button" class="btn btn-success btn-sm" onclick="addNewRow()">
                        <i class="bi bi-plus-circle"></i> Add Row
                    </button>
                </div>

                <div class="col-12">
                    <div class="d-flex align-items-start gap-3">
                        <p class="fw-bold mt-2" style="min-width: 100px;">Comment</p>
                        <textarea class="form-control" name="comment" id="comment" placeholder="Masukkan Komentar" rows="2">@Model.Comment</textarea>
                    </div>
                </div>
            </div>
            <div class="d-flex align-middle justify-content-center pb-3">
                <button type="button" id="btn-validate-submit" class="btn btn-primary me-3" onclick="validateAndSubmit()">Submit</button>
                <a class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#delete-all-model">Reset</a>
                <span id="submitCounter" class="ms-3">Submitted <span id="counter">0</span> time(s)</span>
            </div>
        </form>
    </div>

    @* Modal Insert Product*@
    <div class="modal fade" id="new-model-modal" tabindex="-1" aria-labelledby="new-model-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="new-model-modal-label">Tambah Opsi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" asp-page-handler="InsertProduct">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="new-model" class="col-form-label fw-bold">TAMBAHKAN MODEL BARU JIKA TIDAK ADA PILIHAN MODEL YANG DIINGINKAN</label>
                            <input type="text" class="form-control" id="new-model" name="ProductName">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    @* Modal Update Product*@
    <div class="modal fade" id="edit-model" tabindex="-1" aria-labelledby="Edit-Model-Modal-Label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Edit Data</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" asp-page-handler="UpdateProduct">
                    <input type="hidden" name="Id" />
                    <input type="hidden" name="TargetDate" value="@Model.CurrentDate.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="FilterMachineCode" value="@Model.FilterMachineCode" />
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="" class="col-form-label">Product Name:</label>
                            <input type="text" class="form-control productInput" name="ProductName" placeholder="Silahkan Pilih Model" autocomplete="off" />
                            <div id="dropdown" class="dropdown"></div>
                        </div>
                        <div class="mb-3">
                            <label for="message-text" class="col-form-label">Quantity:</label>
                            <input type="text" class="form-control" name="Quantity" id="quantity" placeholder="Masukkan Quantity" autocomplete="off" />
                        </div>
                        <div class="mb-3">
                            <label for="message-text" class="col-form-label">Overtime:</label>
                            <input type="text" class="form-control" name="Overtime" id="overtime" placeholder="Masukkan Overtime" autocomplete="off" />
                        </div>
                        <div class="mb-3">
                            <label for="message-text" class="col-form-label">QtyHour:</label>
                            <input type="text" class="form-control" name="QtyHour" id="qtyhour" placeholder="Masukkan Quantity/Hour" autocomplete="off" />
                        </div>
                        <div class="mb-3">
                            <label class="col-form-label fw-bold">No Of Direct Worker</label>

                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Normal</label>
                                    <input type="number"
                                           class="form-control"
                                           name="NoOfDirectWorker"
                                           id="noOfDirectWorker"
                                           placeholder="Normal"
                                           autocomplete="off" />
                                </div>

                                <div class="col-6">
                                    <label class="form-label">Overtime</label>
                                    <input type="number"
                                           class="form-control"
                                           name="NoOfDirectWorkerOvertime"
                                           id="noOfDirectWorkerOvertime"
                                           placeholder="Overtime"
                                           autocomplete="off" />
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="col-form-label fw-bold">Shift:</label>

                            <div class="d-flex gap-3 flex-wrap">
                                <div class="form-check">
                                    <input class="form-check-input edit-shift"
                                           type="checkbox"
                                           name="Shift"
                                           value="1"
                                           id="editShift1">
                                    <label class="form-check-label" for="editShift1">S1</label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input edit-shift"
                                           type="checkbox"
                                           name="Shift"
                                           value="2"
                                           id="editShift2">
                                    <label class="form-check-label" for="editShift2">S2</label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input edit-shift"
                                           type="checkbox"
                                           name="Shift"
                                           value="3"
                                           id="editShift3">
                                    <label class="form-check-label" for="editShift3">S3</label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input edit-shift"
                                           type="checkbox"
                                           name="Shift"
                                           value="NS"
                                           id="editShiftNS">
                                    <label class="form-check-label" for="editShiftNS">NS</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    @* Modal Delete Product*@
    <div class="modal fade" id="delete-model" tabindex="-1" aria-labelledby="delete-model-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Delete Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" asp-page-handler="DeleteRecord">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <label for="delete-model" class="col-form-label fw-bold">Apakah anda yakin ingin menghapus data ini ?</label>
                        <input type="hidden" id="delete-record-id" name="RecordId" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-danger">Delete Record</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    @* Modal Delete All Product*@
    <div class="modal fade" id="delete-all-model" tabindex="-1" aria-labelledby="delete-model-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Delete Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" asp-page-handler="DeleteAllRecord">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <label for="delete-model" class="col-form-label fw-bold">Apakah anda yakin ingin me-reset semua data pada hari ini ?</label>
                        <input type="hidden" id="delete-record-id" name="RecordId" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-danger">Delete Record</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/sweetalert2.min.js"></script>
    <script>
        // 1. Event Listener untuk Pesan SweetAlert (Status Message dari Backend)
        document.addEventListener("DOMContentLoaded", function () {
            var statusMessage = '@TempData["StatusMessage"]';
            var message = '@TempData["Message"]';

            if (statusMessage === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: message,
                    confirmButtonText: 'OK'
                });
            } else if (statusMessage === 'error') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: message,
                    confirmButtonText: 'OK'
                });
            }
        });

        // 2. Fungsi Validasi & Submit (Dikeluarkan dari DOMContentLoaded agar bisa dipanggil tombol)
        function validateAndSubmit() {
            // HAPUS BARIS INI (Ini penyebab error submit duluan):
            // document.getElementById('form-production-plan').submit();

            const rows = document.querySelectorAll('#production-table-body tr');
            let hasData = false;       // Penanda ada minimal 1 baris yang diisi
            let isValid = true;        // Penanda semua data valid
            let errorMsg = "";         // Pesan error spesifik

            // Loop setiap baris untuk validasi
            rows.forEach((row, index) => {
                // Ambil element input
                const modelName = row.querySelector('input[name^="ModelName"]').value.trim();
                const quantity = row.querySelector('input[name^="Quantity"]').value.trim();
                const worker = row.querySelector('input[name^="NoOfDirectWorker"]').value.trim(); // Worker Normal

                // Cek apakah baris ini dianggap "Diisi" (salah satu kolom terisi)
                const isRowFilled = modelName !== "" || quantity !== "" || worker !== "";

                if (isRowFilled) {
                    hasData = true;

                    // Aturan Validasi:
                    // Jika salah satu diisi, maka KETIGANYA (Model, Qty, Worker) WAJIB diisi.
                    if (modelName === "" || quantity === "" || worker === "") {
                        isValid = false;
                        // Highlight baris yang error (opsional)
                        row.style.backgroundColor = "#ffe6e6";
                        errorMsg = `Baris ke-${index + 1} tidak lengkap! \nModel Name, Quantity, dan Worker (Normal) wajib diisi.`;
                        return; // Stop checking row ini
                    } else {
                        // Reset warna jika valid
                        row.style.backgroundColor = "";
                    }
                }
            });

            // Validasi 1: Tidak ada data sama sekali
            if (!hasData) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Kosong',
                    text: 'Silakan isi minimal satu baris data (Model, Qty, dan Worker) sebelum submit.',
                    confirmButtonText: 'OK'
                });
                return;
            }

            // Validasi 2: Data tidak lengkap
            if (!isValid) {
                Swal.fire({
                    icon: 'error',
                    title: 'Data Tidak Lengkap',
                    text: errorMsg,
                    confirmButtonText: 'Perbaiki'
                });
                return;
            }

            // Jika semua lolos, lakukan Submit Form
            Swal.fire({
                title: 'Menyimpan Data...',
                text: 'Mohon tunggu sebentar',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const form = document.getElementById('form-production-plan');
            if (form) {
                form.submit();
            } else {
                console.error("Form tidak ditemukan! Pastikan ID form sudah benar.");
                Swal.fire('Error', 'Terjadi kesalahan sistem: Form tidak ditemukan.', 'error');
            }
        }
    </script>

    <script>
        // --- 1. SETUP DATA PRODUCT (Server to Client) ---
        const productNames = @Html.Raw(Model.ProductNames);
        const productNameStrings = productNames.map(product => product.Name);

        // Variabel untuk melacak index baris (dimulai dari total baris yang dirender server)
        // Kita gunakan logic Razor untuk menentukan angka awal
        let currentIndex = document.querySelectorAll('#production-table-body tr').length;

        function addNewRow() {
            const tableBody = document.getElementById('production-table-body');

            const newRowHtml = `
                    <tr>
                        <th scope="row" class="text-center align-middle row-number">${currentIndex + 1}</th>

                        <td>
                            <div class="input-group m-1">
                                 <input disabled type="text" class="form-control" placeholder="-" />
                            </div>
                        </td>
                        <td><div class="m-1"><input disabled type="text" class="form-control" placeholder="-" /></div></td>

                        <td>
                            <div class="input-group m-1 position-relative">
                                <input type="hidden" name="IdModel[${currentIndex}]" value="" />
                                <input type="text" class="form-control productInput" name="ModelName[${currentIndex}]" placeholder="Pilih Model" autocomplete="off" />
                                <a class="btn btn-primary input-group-text" data-bs-toggle="modal" data-bs-target="#new-model-modal">Opsi</a>
                                <div class="dropdown custom-dropdown" style="top: 100%; left: 0; width: 100%;"></div>
                            </div>
                        </td>

                        <td><div class="m-1"><input type="number" class="form-control" name="Quantity[${currentIndex}]" placeholder="Qty" /></div></td>
                        <td><div class="m-1"><input type="number" class="form-control" name="Overtime[${currentIndex}]" placeholder="Ovt" /></div></td>

                        <td><div class="m-1"><input type="number" class="form-control" name="NoOfDirectWorker[${currentIndex}]" placeholder="Normal" /></div></td>
                        <td><div class="m-1"><input type="number" class="form-control" name="NoOfDirectWorkerOvertime[${currentIndex}]" placeholder="Overtime" /></div></td>

                        <td class="align-middle">
                            <div class="d-flex flex-wrap gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Shift[${currentIndex}]" value="1"><label class="form-check-label">S1</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Shift[${currentIndex}]" value="2"><label class="form-check-label">S2</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Shift[${currentIndex}]" value="3"><label class="form-check-label">S3</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Shift[${currentIndex}]" value="NS"><label class="form-check-label">NS</label>
                                </div>
                            </div>
                        </td>

                        <td><div class="m-1"><input type="number" class="form-control" name="QtyHour[${currentIndex}]" placeholder="Qty/Hr" /></div></td>
                        <td><div class="m-1"><input type="text" class="form-control" name="Hour[${currentIndex}]" value="0" readonly /></div></td>

                        <td>
                            <div class="d-flex justify-content-center">
                                <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeRow(this)">X</button>
                            </div>
                        </td>
                    </tr>
                    `;

            tableBody.insertAdjacentHTML('beforeend', newRowHtml);

            // Re-attach events
            const newRow = tableBody.lastElementChild;
            const newInput = newRow.querySelector('.productInput');
            const newDropdown = newRow.querySelector('.custom-dropdown');
            attachDropdownEvent(newInput, newDropdown);

            currentIndex++;
        }

        function openEditModal(btn) {
            document.querySelectorAll('.edit-shift').forEach(cb => cb.checked = false);

            const shiftData = btn.getAttribute('data-shift');
            if (!shiftData) return;

            const shifts = shiftData.split(',');

            shifts.forEach(s => {
                const checkbox = document.querySelector(`.edit-shift[value="${s}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }

        // --- 3. FUNGSI HAPUS BARIS ---
        function removeRow(button) {
            const row = button.closest('tr');
            row.remove();
            reindexRows(); // Opsional: urutkan ulang nomor
        }

        function reindexRows() {
            const rows = document.querySelectorAll('#production-table-body tr');
            rows.forEach((row, index) => {
                const th = row.querySelector('.row-number');
                if (th) th.innerText = index + 1;
            });
        }

        // --- 4. LOGIC DROPDOWN / AUTOCOMPLETE ---

        // Fungsi pembantu untuk menampilkan list
        function showDropdown(input, dropdown, filteredNames) {
            dropdown.innerHTML = '';
            if (filteredNames.length > 0) {
                filteredNames.forEach(name => {
                    const div = document.createElement('div');
                    div.textContent = name;
                    // Styling inline agar mirip dengan CSS Anda sebelumnya
                    div.style.padding = '10px';
                    div.style.cursor = 'pointer';
                    div.onmouseover = () => { div.style.backgroundColor = '#f0f0f0'; };
                    div.onmouseout = () => { div.style.backgroundColor = 'white'; };

                    div.onclick = () => {
                        input.value = name;
                        dropdown.style.display = 'none';
                    };
                    dropdown.appendChild(div);
                });
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        // Fungsi inti untuk memasang event listener ke Input
        function attachDropdownEvent(input, dropdown) {
            // Event saat mengetik
            input.addEventListener('input', () => {
                const query = input.value.toLowerCase();
                const filteredNames = productNameStrings.filter(name => name.toLowerCase().includes(query));
                showDropdown(input, dropdown, filteredNames);
            });

            // Event saat diklik (menampilkan semua atau filter)
            input.addEventListener('click', () => {
                const query = input.value.toLowerCase();
                const filteredNames = productNameStrings.filter(name => name.toLowerCase().includes(query));
                showDropdown(input, dropdown, filteredNames);
            });
        }

        // Inisialisasi awal untuk baris yang sudah ada dari server
        document.addEventListener("DOMContentLoaded", function () {
            const existingInputs = document.querySelectorAll('.productInput');
            existingInputs.forEach(input => {
                // Cari div dropdown yang satu level (sibling) dengan input ini
                const dropdown = input.parentNode.querySelector('.custom-dropdown');
                if (dropdown) {
                    attachDropdownEvent(input, dropdown);
                }
            });
        });

        // Menutup dropdown jika klik di luar
        document.addEventListener('click', (event) => {
            const isInput = event.target.classList.contains('productInput');
            const isDropdownItem = event.target.closest('.custom-dropdown');

            if (!isInput && !isDropdownItem) {
                document.querySelectorAll('.custom-dropdown').forEach(d => d.style.display = 'none');
            }
        });

        function setModalData(button) {
            const row = button.closest('tr');

            // Fungsi helper untuk ambil value dari input row
            const getVal = name => {
                const input = row.querySelector(`input[name^="${name}"]`);
                return input ? input.value : '';
            };

            const modal = document.querySelector('#edit-model form');

            // 1. Set ID & Basic Data
            modal.querySelector('input[name="Id"]').value = getVal("IdModel");
            modal.querySelector('input[name="ProductName"]').value = getVal("ModelName");
            modal.querySelector('input[name="Quantity"]').value = getVal("Quantity");
            modal.querySelector('input[name="Overtime"]').value = getVal("Overtime");
            modal.querySelector('input[name="QtyHour"]').value = getVal("QtyHour");

            // 2. Set Worker Data (Baru)
            const wNorm = modal.querySelector('input[name="NoOfDirectWorker"]');
            if (wNorm) wNorm.value = getVal("NoOfDirectWorker");

            const wOvt = modal.querySelector('input[name="NoOfDirectWorkerOvertime"]');
            if (wOvt) wOvt.value = getVal("NoOfDirectWorkerOvertime");

            // 3. Set Shift Checkboxes
            // Reset dulu semua checkbox di modal
            modal.querySelectorAll('.edit-shift').forEach(cb => cb.checked = false);

            // Cari checkbox yang tercentang di ROW tabel
            const checkedShiftsInRow = row.querySelectorAll('input[name^="Shift"]:checked');
            checkedShiftsInRow.forEach(cb => {
                const val = cb.value; // 1, 2, 3, atau NS
                // Cari checkbox yang sesuai di MODAL dan centang
                const modalCb = modal.querySelector(`.edit-shift[value="${val}"]`);
                if (modalCb) modalCb.checked = true;
            });
        }

        function setDeleteRecordId(recordId) {
            document.getElementById("delete-record-id").value = recordId;
        }
    </script>
</body>
</html>