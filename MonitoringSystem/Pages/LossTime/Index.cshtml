@page
@using System.Globalization;
@model MonitoringSystem.Pages.LossTime.IndexModel
@{
    ViewData["Title"] = "Loss Time";
    /* Pa Adan Disini */
}

<style>
    /*Kita dikejar pa Daniel Februari minggu pertama*/


/* CONTAINER FLUID PADDING - SAMA DENGAN PRODUCTION REPORT */
.container-fluid {
    padding-left: 0px !important;
    padding-right: 0px !important;
}

/* REMOVE EXTRA MARGIN FROM ROWS */
.row.d-flex.justify-content-between.mx-3 {
    margin-left: 0 !important;
    margin-right: 0 !important;
}

/* CARD SPACING - SAMA DENGAN PRODUCTION REPORT */
.row.mt-2 {
    margin-left: -21px !important;   /* ← UBAH dari -18px jadi -7px */
    margin-right: -21px !important;  /* ← UBAH dari -18px jadi -7px */
}

.row.mt-2:first-of-type {
    margin-top: 0.25rem !important;
}

.row.mt-2 > div[class*="col-"] {
    padding-left: 5px !important;
    padding-right: 5px !important;
}

/* ← GANTI YANG INI - LEBIH KUAT */
.row.mt-2 > .col-12 {
    padding-left: 5px !important;
    padding-right: 5px !important;
}

/* ← TAMBAHIN INI JUGA - DOUBLE FORCE */
.row.mt-2:last-of-type > div {
    padding-left: 5px !important;
    padding-right: 5px !important;
}

.row.mt-2 .card {
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
}

/* FILTER AREA WITH LINES - SUPER COMPACT */
.filter-area-with-lines {
    position: relative;
    padding: 1px 0;
    margin-bottom: 8px;
    margin-top: -20px;
    min-height: 10px;
    width: calc(100% - 14px);  /* ← UBAH dari 18px jadi 14px */
    margin-left: 7px;
    margin-right: 7px;
}

.panamon-bottom-line,
.panamon-bottomm-line {
    position: absolute !important;
    left: -13px !important;  /* ← UBAH dari 0px jadi 7px */
    right: -13px !important;  /* ← UBAH dari 0px jadi 7px */
    /* HAPUS baris width! */
    height: 2px !important;
    background: rgba(255, 255, 255, 0.04) !important;
    z-index: 999 !important;
    pointer-events: none !important;
    display: block !important;
}


.panamon-bottom-line {
    top: 0 !important;
    border-top: 2px solid rgba(255, 255, 255, 0.08) !important;
}

.panamon-bottomm-line {
    bottom: 0 !important;
    border-bottom: 2px solid rgba(255, 255, 255, 0.08) !important;
}

/* FILTER CONTENT - SUPER COMPACT */
.filter-content {
    position: relative;
    z-index: 2;
    padding: 6px 0;
    border-radius: 15px;
    margin-left: -8px;
    margin-right: 7px;
}
/* Tambahkan di bagian style */
.filter-content .form-select.selected {
    font-weight: 700 !important; /* Bold saat dipilih */
}
.filter-content .form-select,
.filter-content .form-control {
    height: 28px;
    padding: 0 22px 0 8px;
    font-size: 12px;
    line-height: 20px;  /* ← Pastikan ini sama dengan height */
    border-radius: 999px;
    background-color: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.5);
    color: #ffffff;
    text-align: center;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    padding-top: 0;     /* ← TAMBAH */
    padding-bottom: 0;  /* ← TAMBAH */
    vertical-align: middle; /* ← TAMBAH */
}

.filter-content .form-select {
    height: 28px;
    padding: 0 !important;  /* ← RESET semua padding */
    padding-left: 12px !important;
    padding-right: 28px !important;
    padding-top: -2px !important;  /* ← NEGATIVE padding, ini trik nya! */
    font-size: 12px;
    line-height: 16px;  /* ← UBAH dari 20px jadi 16px */
    border-radius: 999px;
    background-color: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.5);
    color: #ffffff;
    text-align: center;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    display: flex;
    align-items: center;
    justify-content: center;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 10px 10px;
}
.filter-content .form-select option {
    background-color: rgba(50, 60, 80, 0.95);
    color: #ffffff;
    font-size: 12px;
    padding: 8px;
}

.filter-content .form-select option:hover {
    background-color: rgba(70, 85, 110, 0.95);
}

.filter-content .form-select:focus,
.filter-content .form-control:focus {
    background-color: rgba(255, 255, 255, 0.20);
    border-color: rgba(255, 255, 255, 0.3);
    color: #ffffff;
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.1);
}

.filter-content label {
    color: rgba(255, 255, 255, 0.85);
    font-size: 14px;
    line-height: 20px;
    font-weight: 600;
}

.filter-content .form-check-input {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.4);
    border-radius: 8px;
    width: 14px;
    height: 14px;
    margin-top: 2px;
}

.filter-content .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.filter-content .form-check-label {
    font-size: 10px;
    line-height: 20px;
}

.filter-content .btn {
    height: 28px;
    min-height: 20px;
    padding: 0 12px;
    font-size: 12px;
    line-height: 20px;
    border-radius: 999px !important;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
}

.filter-content .btn-primary {
    background-color: rgba(8, 65, 150, 0.95);
    border: 2px solid rgba(100, 181, 246, 1);
    color: rgba(100, 181, 246, 1);
}

.filter-content .btn-primary:hover {
    background-color: rgba(5, 45, 110, 1);
    border-color: rgba(144, 202, 249, 1);
    color: rgba(144, 202, 249, 1);
}

.filter-content .btn-success {
    background-color: rgba(20, 100, 50, 0.95);
    border: 2px solid rgba(129, 199, 132, 1);
    color: rgba(129, 199, 132, 1);
}

.filter-content .btn-success:hover {
    background-color: rgba(15, 75, 35, 1);
    border-color: rgba(165, 214, 167, 1);
    color: rgba(165, 214, 167, 1);
}

.filter-content .btn-danger {
    background-color: rgba(140, 30, 40, 0.95);
    border: 2px solid rgba(239, 154, 154, 1);
    color: rgba(239, 154, 154, 1);
}

.filter-content .btn-danger:hover {
    background-color: rgba(110, 20, 30, 1);
    border-color: rgba(244, 143, 177, 1);
    color: rgba(244, 143, 177, 1);
}

/* CUSTOM SHIFT BUTTONS - KOTAK KAYAK PRODUCTION REPORT */
.shift-button {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background-color: rgba(70, 80, 100, 0.6);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: #ffffff;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
}

.shift-button:hover {
    background-color: rgba(90, 100, 120, 0.7);
    border-color: rgba(255, 255, 255, 0.5);
}

.shift-button.active {
    background-color: rgba(50, 60, 80, 0.9);
    border: 3px solid #ffffff;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.4);
}

input[type="checkbox"]:checked + .shift-button {
    background-color: rgba(50, 60, 80, 0.9);
    border: 3px solid #ffffff;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.4);
}

/* CUSTOM CARD STYLE TO MATCH DARK THEME */
/* CUSTOM CARD STYLE TO MATCH PRODUCTION REPORT */
.card {
    background-color: rgba(255, 255, 255, 0.20) !important;  /* ← UBAH dari 0.05 jadi 0.20 */
    border: 2px solid rgba(255, 255, 255, 0.3) !important;   /* ← UBAH dari 1px 0.1 jadi 2px 0.3 */
    border-radius: 12px;                                      /* ← TAMBAH ini */
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);               /* ← TAMBAH ini */
}

.card-title {
    color: #ffffff;
}
/* TABEL LOSS TIME DATA - SAMAIN WARNA DENGAN CARD */
#lossTimeTable {
    font-size: 12px;
    background-color: transparent !important;  /* ← TAMBAH ini */
}

#lossTimeTable thead th {
    font-size: 12px;
    background-color: rgba(0, 0, 0, 0.5) !important;  /* ← UBAH background header */
    color: #ffffff !important;
    border-color: rgba(255, 255, 255, 0.2) !important;
}

#lossTimeTable tbody td {
    font-size: 12px;
    padding: 4px 6px;
    background-color: transparent !important;  /* ← TAMBAH ini */
    color: #ffffff !important;  /* ← UBAH dari default jadi putih */
    border-color: rgba(255, 255, 255, 0.2) !important;  /* ← TAMBAH border */
}

#lossTimeTable tbody tr {
    background-color: transparent !important;  /* ← TAMBAH ini */
}

#lossTimeTable tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;  /* ← Hover effect */
}

#lossTimeTable .btn-sm {
    font-size: 13px !important;
    padding: 5px 11px !important;
    min-width: 30px;
    line-height: 1.2;
}

/* TABEL STRIPED - HAPUS ATAU UBAH */
#lossTimeTable.table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(255, 255, 255, 0.05) !important;  /* ← Stripe tipis */
}
/* BIAR TABEL NGIKUTIN TINGGI CARD */
/* BIAR TABEL NGIKUTIN TINGGI CARD DAN ADA SCROLL VERTIKAL */
.col-md-4 .card-body {
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 0 !important; /* Hilangkan padding biar table full */
}

.col-md-4 .table-responsive {
    flex: 1;
    overflow-y: auto !important;  /* ← INI YANG PENTING, SCROLL VERTIKAL */
    overflow-x: hidden !important; /* Gak ada scroll horizontal */
    max-height: 350px !important; /* Batasi tinggi biar gak numbuh */
}

/* Biar scrollbar keliatan */
.col-md-4 .table-responsive::-webkit-scrollbar {
    width: 8px;
}

.col-md-4 .table-responsive::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

.col-md-4 .table-responsive::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
}

.col-md-4 .table-responsive::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}
/* PAGINATION STYLING - DARK THEME */
.pagination .page-link {
    background-color: rgba(255, 255, 255, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    color: #ffffff !important;
    font-size: 11px;
    padding: 4px 10px;
}

.pagination .page-link:hover {
    background-color: rgba(255, 255, 255, 0.2) !important;
    border-color: rgba(255, 255, 255, 0.5) !important;
    color: #ffffff !important;
}

.pagination .page-item.active .page-link {
    background-color: rgba(100, 181, 246, 0.8) !important;
    border-color: rgba(100, 181, 246, 1) !important;
    color: #ffffff !important;
    font-weight: 700;
}

.pagination .page-item.disabled .page-link {
    background-color: rgba(255, 255, 255, 0.05) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
    color: rgba(255, 255, 255, 0.3) !important;
}

</style>

<div class="filter-area-with-lines">    
    <div class="panamon-bottom-line"></div>
    <div class="panamon-bottomm-line"></div>

    <div class="filter-content">
            <form method="post" asp-page-handler="Filter" class="d-flex flex-wrap align-items-center gap-3">
                <div class="d-flex align-items-center gap-2">
                    <label class="mb-0">Line</label>
                    <select class="form-select" style="width: 60px;" id="MachineLine" name="MachineLine" asp-for="MachineLine">
                        <option value="All">All</option>
                        <option value="MCH1-01">CU</option>
                        <option value="MCH1-02">CS</option>
                    </select>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <label class="mb-0">Month</label>
                    <select class="form-select" style="width: 110px;" id="SelectedMonth" name="SelectedMonth" asp-for="SelectedMonth">
                        @for (int i = 1; i <= 12; i++)
                        {
                          <option value="@i">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)</option>
                        }
                    </select>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <label class="mb-0">Year</label>
                    <select class="form-select" style="width: 80px;" id="SelectedYear" name="SelectedYear" asp-for="SelectedYear">
                    @for (int i = DateTime.Now.Year - 3; i <= DateTime.Now.Year + 5; i++)
                        {
                          <option value="@i">@i</option>
                        }
                    </select>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <label class="mb-0">Shift</label>
                            <div class="d-flex gap-2 shift-buttons-container">
                                <input type="checkbox" id="Shift1" name="SelectedShifts" value="1" 
                                            @(Model.SelectedShifts != null && Model.SelectedShifts.Contains("1") ? "checked" : "") 
                                       style="display: none;">
                                <label for="Shift1" class="shift-button">1</label>

                                <input type="checkbox" id="Shift2" name="SelectedShifts" value="2" 
                                            @(Model.SelectedShifts != null && Model.SelectedShifts.Contains("2") ? "checked" : "") 
                                       style="display: none;">
                                <label for="Shift2" class="shift-button">2</label>

                                <input type="checkbox" id="Shift3" name="SelectedShifts" value="3" 
                                            @(Model.SelectedShifts != null && Model.SelectedShifts.Contains("3") ? "checked" : "") 
                                       style="display: none;">
                                <label for="Shift3" class="shift-button">3</label>
                             </div>
                </div>

              <button type="submit" class="btn btn-primary">Search</button>
               <button type="submit" asp-page-handler="ExportExcel" class="btn btn-success">
                     <i class="fas fa-file-excel me-1"></i> Export CSV
                </button>
                <button type="submit" asp-page-handler="Reset" class="btn btn-danger">Reset</button>

                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-file-excel me-2"></i>Upload Actual Loss
                </button>
            </form>
    </div>
</div>

<div class="row mt-2">
    <div class="col-md-8">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0 fw-bold fs-8 text-white">
                    Loss Time Categories @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(Model.SelectedMonth)</h5>
            </div>
            <div class="card-body">
                <canvas id="lossTimeChart" style="width: 100%; height: 280px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0 fw-bold fs-8 text-white">Detail Loss Time</h5>
            </div>
            <div class="card-body p-0">
                @if (Model.HasDataToDisplay)
                {
                            <div class="table-responsive" style="height: 100%;">
                                <table class="table table-hover table-striped mb-0 text-white" id="lossTimeTable">
                                    <thead class="sticky-top bg-dark text-white">
                                        <tr>
                                            <th>No.</th>
                                            <th>Date</th>
                                            <th>Category</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Duration</th>
                                            <th>Location</th>
                                            <th>Shift</th>
                                            <th>Detailed</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lossTimeTableBody">
                                @foreach (var item in Model.LossTimeData.Select((data, index) => new { Data = data, Index = index + 1 + (Model.CurrentPage - 1) * Model.PageSize }))
                                {
                                                <tr>
                                                    <td>@item.Index</td>
                                                    <td>@item.Data.Date.ToString("dd-MM-yyyy")</td>
                                                    <td>@item.Data.Category</td>
                                                    <td>@item.Data.Start.ToString(@"hh\:mm\:ss")</td>
                                                    <td>@item.Data.End.ToString(@"hh\:mm\:ss")</td>
                                                    <td>@item.Data.Duration</td>
                                                    <td>@item.Data.Location</td>
                                                    <td>@item.Data.Shift</td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-info text-white"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#detailedReasonModal"
                                                                data-reason="@item.Data.DetailedReason">
                                                            View
                                                        </button>
                                                    </td>
                                                </tr>
                                }
                                    </tbody>
                                </table>
                            </div>
                }
                else
                {
                            <div class="d-flex align-items-center justify-content-center" style="height: 350px;">
                                <div class="text-center text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <h5>No Data Available</h5>
                                    <p>No records found for the selected criteria.</p>
                                </div>
                            </div>
                }
            </div>
            @if (Model.HasDataToDisplay)
            {
                        <div class="card-footer bg-transparent border-top border-secondary">
                            <div class="d-flex justify-content-between align-items-center text-white">
                                <div>
                                    <span class="fw-bold">Total: @Model.TotalRecords records</span>
                                </div>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination mb-0">
                                        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                            <form method="post" asp-page-handler="ChangePage">
                                                <input type="hidden" name="pageNumber" value="@(Model.CurrentPage - 1)" />
                                                <input type="hidden" name="pageSize" value="10" />
                                                <input type="hidden" name="selectedMonth" value="@Model.SelectedMonth" />
                                                <input type="hidden" name="selectedYear" value="@Model.SelectedYear" />
                                                <input type="hidden" name="machineLine" value="@Model.MachineLine" />
                                        @foreach (var shift in Model.SelectedShifts)
                                        {
                                                        <input type="hidden" name="selectedShifts" value="@shift" />
                                        }
                                                <input type="hidden" name="additionalBreakTime1Start" value="@Model.AdditionalBreakTime1Start" />
                                                <input type="hidden" name="additionalBreakTime1End" value="@Model.AdditionalBreakTime1End" />
                                                <input type="hidden" name="additionalBreakTime2Start" value="@Model.AdditionalBreakTime2Start" />
                                                <input type="hidden" name="additionalBreakTime2End" value="@Model.AdditionalBreakTime2End" />
                                                <button type="submit" class="page-link">&lsaquo;</button>
                                            </form>
                                        </li>
                                        <li class="page-item active"><span class="page-link">@Model.CurrentPage</span></li>
                                        <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")">
                                            <form method="post" asp-page-handler="ChangePage">
                                                <input type="hidden" name="pageNumber" value="@(Model.CurrentPage + 1)" />
                                                <input type="hidden" name="pageSize" value="10" />
                                                <input type="hidden" name="selectedMonth" value="@Model.SelectedMonth" />
                                                <input type="hidden" name="selectedYear" value="@Model.SelectedYear" />
                                                <input type="hidden" name="machineLine" value="@Model.MachineLine" />
                                        @foreach (var shift in Model.SelectedShifts)
                                        {
                                                        <input type="hidden" name="selectedShifts" value="@shift" />
                                        }
                                                <input type="hidden" name="additionalBreakTime1Start" value="@Model.AdditionalBreakTime1Start" />
                                                <input type="hidden" name="additionalBreakTime1End" value="@Model.AdditionalBreakTime1End" />
                                                <input type="hidden" name="additionalBreakTime2Start" value="@Model.AdditionalBreakTime2Start" />
                                                <input type="hidden" name="additionalBreakTime2End" value="@Model.AdditionalBreakTime2End" />
                                                <button type="submit" class="page-link">&rsaquo;</button>
                                            </form>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
            }
        </div>
    </div>
</div>

<div class="row mt-2" style="margin-bottom: 2px; margin-left: -18px; margin-right: -18px;">
    <div class="col-12"  style="padding-left: 5px; padding-right: 5px;">
        <div class="card shadow-sm">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0 fw-bold fs-8 text-white">Daily Loss Time @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(Model.SelectedMonth)</h5>
            </div>
            <div class="card-body">
                <canvas id="dailyLossChart" style="width: 100%; height: 350px;"></canvas>
            </div>
        </div>
    </div>
</div>
<!-- UPLOAD MODAL -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="uploadModalLabel"><i class="fas fa-file-upload"></i> Upload Actual Loss Data Daily</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" enctype="multipart/form-data" asp-page-handler="ImportExcelActual">
                <div class="modal-body">
                   @*  <input type="hidden" name="SelectedYear" value="@Model.SelectedYear" />
                    <input type="hidden" name="MachineLine" value="@Model.MachineLine" /> *@
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. Choose Excel File</label>
                        <input type="file" name="UploadedExcel" class="form-control" accept=".xlsx" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">2. Select Target Machine for Actual Data</label>
                        <select name="UploadMachineLine" class="form-select" required>
                            <option value="MCH1-01">MCH1-01 (CU)</option>
                            <option value="MCH1-02">MCH1-02 (CS)</option>
                        </select>
                        <div class="form-text text-muted">You must specify which machine this file belongs to.</div>
                    </div>
                   
                    <hr />
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="TargetMonth" class="form-label">Untuk Bulan:</label>
                            <select id="TargetMonth" name="TargetMonth" class="form-select" required>
                                @for (int i = 1; i <= 12; i++)
                                {
                                    <option value="@i">@CultureInfo.GetCultureInfo("en-US").DateTimeFormat.GetMonthName(i)</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="TargetYear" class="form-label">Untuk Tahun:</label>
                            <select id="TargetYear" name="TargetYear" class="form-select" required>
                                @for (int i = DateTime.Now.Year - 3; i <= DateTime.Now.Year + 5; i++)
                                {
                                    <option value="@i">@i</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">Need the format?</span>
                        <a asp-page-handler="DownloadTemplateActualLoss" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download"></i> Download Template
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-small text-white" style="background-color: rgb(25, 135, 84);">Import Actual Loss Data</button>
                </div>
            </form>
        </div>
    </div>
</div>
<style>
LOSS TIME SUMMARY - COMPACT & MODERN
.loss-summary-compact {
    font-size: 10px;
}

.loss-summary-compact .card {
    background-color: rgba(255, 255, 255, 0.20) !important;
    border: 2px solid rgba(255, 255, 255, 0.3) !important;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

.loss-summary-compact .card-title {
    font-size: 12px;
    color: #ffffff;
    font-weight: 700;
    margin-bottom: 8px;
}

.loss-summary-compact .category-item {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    margin: 3px;
}

.loss-summary-compact .category-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.loss-summary-compact .category-name {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.85);
    font-weight: 600;
}

.loss-summary-compact .category-value {
    font-size: 11px;
    color: #ffffff;
    font-weight: 700;
    margin-left: 4px;
}

.loss-summary-compact .grand-total {
    padding-top: 8px;
    border-top: 2px solid rgba(255, 255, 255, 0.2);
    margin-top: 8px;
}

.loss-summary-compact .grand-total-label {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.85);
    font-weight: 600;
}

.loss-summary-compact .grand-total-value {
    font-size: 12px;
    color: #ffffff;
    font-weight: 700;
}
</style>

@*<div class="row mt-2 loss-summary-compact">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body" style="padding: 12px;">
                <h6 class="card-title text-center">Total Loss Time Summary</h6>

                <div class="d-flex justify-content-center flex-wrap">
                    @{
                        string[] allCategories = {
                            "Change Model",
                            "Material Shortage External",
                            "MP Adjustment",
                            "Material Shortage Internal",
                            "Material Shortage Inhouse",
                            "Quality Trouble",
                            "Machine Trouble",
                            "Rework",
                            "Morning Assembly",
                            "Reason Not Fill"
                                    };

                        foreach (var category in allCategories)
                        {
                            int categoryValue = Model.CategorySummary.ContainsKey(category) ? Model.CategorySummary[category] : 0;
                            decimal minutes = Math.Round((decimal)categoryValue / 60, 2);

                                    <div class="category-item">
                                        <div class="category-dot" style="background-color: @GetCategoryColor(category);"></div>
                                        <span class="category-name">@category:</span>
                                        <span class="category-value">@minutes min</span>
                                    </div>
                        }
                    }
                </div>

                <div class="grand-total text-center">
                    <span class="grand-total-label">Grand Total:</span>
                    <span class="grand-total-value">@Math.Round((decimal)Model.TotalDuration / 60, 2) min</span>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    public string GetCategoryColor(string category)
    {
        switch (category)
        {
            case "Change Model": return "#4e73df";
            case "Material Shortage External": return "#e74a3b";
            case "MP Adjustment": return "#f6c23e";
            case "Material Shortage Internal": return "#1cc88a";
            case "Material Shortage Inhouse": return "#36b9cc";
            case "Quality Trouble": return "#9c50f2";
            case "Machine Trouble": return "#e27267";
            case "Rework": return "#f39c12";
            case "Morning Assembly": return "#5a5c69";
            default: return "#858796";
        }
    }
}*@

<div class="modal fade" id="detailedReasonModal" tabindex="-1" aria-labelledby="detailedReasonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="detailedReasonModalLabel">Detailed Reason</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="detailedReasonText"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="~/js/chart.umd.min.js"></script>
<script>
    // Global Config for Dark Mode
    const chartTextColor = '#ffffff';
    const chartGridColor = 'rgba(255, 255, 255, 0.1)';

    let summaryChartData;
    try {
        summaryChartData = @Html.Raw(Json.Serialize(Model.ChartDataJson));
        if (typeof summaryChartData === 'string') summaryChartData = JSON.parse(summaryChartData);
    } catch (error) {
        console.error("Error parsing summary chart data:", error);
        summaryChartData = { labels: [], shift1Data: [], shift2Data: [], shift3Data: [], lastMonthData: [] };
    }

    let dailyChartData;
    try {
        dailyChartData = @Html.Raw(Json.Serialize(Model.DailyChartDataJson));
        if (typeof dailyChartData === 'string') dailyChartData = JSON.parse(dailyChartData);
    } catch (error) {
        console.error("Error parsing daily chart data:", error);
        dailyChartData = { labels: [], datasets: [] };
    }

    // ✅ PINDAHIN FUNCTION KELUAR DARI DOMCONTENTLOADED
    function updateDropdownStyle() {
        const dropdowns = document.querySelectorAll('.filter-content .form-select');
        dropdowns.forEach(dropdown => {
            const dropdownName = dropdown.name;
            const dropdownValue = dropdown.value;

            // KHUSUS LINE: Bold kalau bukan "All"
            if (dropdownName === 'MachineLine') {
                if (dropdownValue && dropdownValue !== 'All') {
                    dropdown.classList.add('selected');
                } else {
                    dropdown.classList.remove('selected');
                }
            }
            // KHUSUS MONTH: Bold kalau bukan bulan sekarang
            else if (dropdownName === 'SelectedMonth') {
                const currentMonth = new Date().getMonth() + 1;
                if (dropdownValue && parseInt(dropdownValue) !== currentMonth) {
                    dropdown.classList.add('selected');
                } else {
                    dropdown.classList.remove('selected');
                }
            }
            // KHUSUS YEAR: Bold kalau bukan tahun sekarang
            else if (dropdownName === 'SelectedYear') {
                const currentYear = new Date().getFullYear();
                if (dropdownValue && parseInt(dropdownValue) !== currentYear) {
                    dropdown.classList.add('selected');
                } else {
                    dropdown.classList.remove('selected');
                }
            }
        });
    }

    // ===== SATU-SATUNYA DOM CONTENT LOADED =====
    document.addEventListener('DOMContentLoaded', function() {
        // 1. RENDER LOSS TIME CHART
        const ctxSummary = document.getElementById('lossTimeChart').getContext('2d');
        if (ctxSummary) {
            new Chart(ctxSummary, {
                type: 'bar',
                data: {
                    labels: summaryChartData.labels,
                    datasets: [
                        { label: 'Last Month', data: summaryChartData.lastMonthData, backgroundColor: 'rgba(201, 203, 207, 0.95)', stack: 'last' },
                        { label: 'Shift 1', data: summaryChartData.shift1Data, backgroundColor: 'rgba(255, 99, 132, 0.95)', stack: 'current' },
                        { label: 'Shift 2', data: summaryChartData.shift2Data, backgroundColor: 'rgba(54, 162, 235, 0.95)', stack: 'current' },
                        { label: 'Shift 3', data: summaryChartData.shift3Data, backgroundColor: 'rgba(75, 192, 192, 0.95)', stack: 'current' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: chartTextColor } },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    return summaryChartData.fullLabels[context[0].dataIndex];
                                },
                                label: function (c) {
                                    return `${c.dataset.label}: ${c.raw} min`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, ticks: { color: chartTextColor }, grid: { color: chartGridColor } },
                        y: {
                            beginAtZero: true,
                            stacked: true,
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor },
                            title: { display: true, text: 'Duration (Min)', color: chartTextColor }
                        }
                    }
                }
            });
        }

        // 2. RENDER DAILY LOSS CHART
        const ctxDaily = document.getElementById('dailyLossChart').getContext('2d');
        if (ctxDaily) {
            new Chart(ctxDaily, {
                type: 'bar',
                data: dailyChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: chartTextColor } },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: { label: function(c) { return `${c.dataset.label}: ${c.raw} min`; } }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor },
                            title: { display: true, text: 'Day of Month', color: chartTextColor }
                        },
                        y: {
                            beginAtZero: true,
                            stacked: true,
                            ticks: { color: chartTextColor },
                            grid: { color: chartGridColor },
                            title: { display: true, text: 'Duration (Minutes)', color: chartTextColor }
                        }
                    }
                }
            });
        }

        // 3. RESTORE SHIFT BUTTON STATES
        const shiftCheckboxes = document.querySelectorAll('input[name="SelectedShifts"]');
        shiftCheckboxes.forEach(checkbox => {
            const button = document.querySelector(`label[for="${checkbox.id}"]`);
            if (checkbox.checked && button) {
                button.classList.add('active');
            }
        });

        // 4. HANDLE SHIFT BUTTON CLICKS
        const shiftButtons = document.querySelectorAll('.shift-button');
        shiftButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const checkbox = document.getElementById(this.getAttribute('for'));
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('active', checkbox.checked);
                }
            });
        });

        // 5. UPDATE DROPDOWN STYLE - JALANIN SETELAH PAGE LOAD PENUH
        // ✅ Paksa delay biar asp-for binding kelar dulu
        setTimeout(function() {
            updateDropdownStyle();
        }, 50);

        // Event listener untuk perubahan manual
        const dropdowns = document.querySelectorAll('.filter-content .form-select');
        dropdowns.forEach(dropdown => {
            dropdown.addEventListener('change', updateDropdownStyle);
        });

        // 6. DETAILED REASON MODAL
        const detailedReasonModal = document.getElementById('detailedReasonModal');
        if (detailedReasonModal) {
            detailedReasonModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var reason = button.getAttribute('data-reason');
                var modalBodyText = this.querySelector('.modal-body p#detailedReasonText');
                modalBodyText.textContent = (reason && reason.trim() !== '') ? reason : 'No detailed reason provided.';
            });
        }
    });
</script>